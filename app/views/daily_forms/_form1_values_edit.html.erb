<%# daily_form, form1_values %>

<%= form_tag '#', :class=>"form1-value-form" do %>
	<%= submit_tag "繳交", :class=>'submit' %>
	<table class="table form1-value-form-table">
		<thead>		
			<tr>
				<td></td>
				<td> 客戶 </td>
				<td> 廠商 </td>
				<td> 送貨員 </td>
				<td> 欄數 </td>
				<td> 備註 </td>
				<td></td>
			</tr>
		</thead>
		<tbody>		
		
		<%= render :partial=>"daily_forms/form1_values_edit_row.html", 
							 :collection=> form1_values, 
							 :as=> :form1_value %>

		</tbody>
	</table>

	<%= link_to "新增行數", "", :class=>"form1-value-new btn btn-success" %>

<% end %>

<script>

$(document).ready(function(){

	var submitData = function(){
		var data = {}
		$('.form1-value-form-table tr').each(function(index,element){
			if ($(element).attr('update') === "1"){
				$(element).find('input,select').each(function(i,input){
					data[$(input).attr('name')] = $(input).val();
				})
			}
		})
		return data;
	}

	var refreshRows = function(){
		var del = "<a href='' class='form1-value-delete btn btn-danger btn-xs'>X</a>"
		$('.form1 tr').each(function(index,element){
			$(element).find('.order').text(index);
			var id = $(element).find('.form1-value-id').attr('value');
			var update = $(element).attr('update');
			if (id || update==="1"){
				$(element).find('.delete').html(del);
			}
		})
	}

	var clearUpdate = function(){
		$('.form1 tr').each(function(index,element){
			$(element).attr('update',0);
		})
	}

	$('.form1 .form1-value-form').submit(function(e){
		e.preventDefault();

		$.ajax({
			url: "<%= update_form1_daily_form_path(daily_form) %>",
			data: {data:submitData(),submit:1},
			method: 'patch',
			dataType: 'json',
			success: function(data){
				$('.form1').html(data['template'])
			}
		})
	})

	var currentRow = 0
	$('.form1 .form1-value-form').on('focus','input,select',function(e){
		e.preventDefault();
		var row = parseInt($(this).closest('tr').attr('row'));
		if (currentRow != row){
			currentRow = row;
			$.ajax({
				url: "<%= update_form1_daily_form_path(daily_form) %>",
				data: {data:submitData(),submit:2},
				method: 'patch',
				dataType: 'json',
				success: function(data){
					console.log('update');
					var map_keys = $.parseJSON(data['result']);
					for(index in map_keys){
						$('.form1 [row=' + index + '] .form1-value-id').attr('value',map_keys[index])
					}	
					clearUpdate();					
				}
			})
		}
	})

	$('.form1').on('click','.form1-value-delete',function(e){
			e.preventDefault();
			var target = $(this).closest('tr')
			var index = target.attr('row');
			var id = $('.form1 [row=' + index + '] .form1-value-id').attr('value')

			if (id){
				$.ajax({
					url:"/daily_forms/delete_form1_value/" + id,
					method: 'delete',
					dataType: 'json',
					success: function(data){
						if (data['result'].toLowerCase()==="ok"){
							target.remove();
							refreshRows();
						}
					}
				})
			}else{
				$(this).closest('tr').remove();
				refreshRows();
			}
	})

	$('.form1').on('click','.form1-value-new',function(e){
			e.preventDefault();
			var index = parseInt($('.form1-value-form-table tr').last().attr('row')) +1;

			$.ajax({
				url: "<%= new_form1_value_daily_forms_path %>",
				data:{index: index},
				method:'get',
				dataType: 'json',
				success: function(data){
					$('.form1 tbody').append(data['template']);
					addCustomerSelect2($('.form1-value-' + index + ' .form1-value-customer'));
				}
			})
	})

	$('.form1').on('change','input,select',function(){
		$($(this).closest('tr')).attr('update',1)
		refreshRows();
	})


	var addCustomerSelect2 = function(object){
		object.select2({
			width: '180px',
			height: '16px',
			data: <%= raw @customer_list.to_json %>
		})
	}	

	addCustomerSelect2($('.form1-value-customer'));
	refreshRows();


})



</script>


