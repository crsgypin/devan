<%# daily_form %>

<script>

//form2
$(document).ready(function(){
	$('.form2-show').on('click','.edit-button',function(e){
		e.preventDefault();
		$.ajax({
			url:$(this).attr('href'),
			dataType:'json',
			success:function(data){
				$('.form2-edit').html(data['template']);
				$('.form2-edit').show();
				$('.form2-show').hide();
				form2.addCustomerSelect2($('.form2-value-customer'));
				form2.refreshRows();
			}
		})
	})

	var form2 = {
		currentRow: 0,
		urls: {
						submit:"<%= update_form2_daily_form_path(daily_form) %>",
						remove:"/daily_forms/delete_form2_value/",
						add:"<%= new_form2_value_daily_forms_path %>"
		},
		submitData: function(){
			var data = {};
			$('.form2-value-form-table tr').each(function(index,tr){
				if ($(tr).attr('update') === "1"){
					$(tr).find('input,select').each(function(i,input){
						data[$(input).attr('name')] = $(input).val();
					})
				}
			})
			return data;
		},
		refreshRows: function(){
			$('.form2-edit tr').each(function(row,tr){
				$(tr).find('.row-number').text(row);
				$(tr).attr('row',row);
				var update = $(tr).attr('update');
				if (update==="1"){
					$(tr).find('.updating').css({opacity:1});
				}else{
					$(tr).find('.updating').css({opacity:0});
				}
			})
		},
		addCustomerSelect2: function(object){
			object.select2({
				width: '180px',
				height: '16px',
				data: <%= raw @customer_list.to_json %>
			})
		}	

	}

	$('.form2-edit').on('submit','.form2-value-form',function(e){
		e.preventDefault();
		$.ajax({
			url: form2.urls['submit'],
			data: {data: form2.submitData(),submit:1},
			method: 'patch',
			dataType: 'json',
			success: function(data){
				$('.form2-show').html(data['template'])
				$('.form2-edit').hide();
				$('.form2-show').show();
			}
		})
	})

	$('.form2-edit').on('focus','input,select',function(e){
		e.preventDefault();
		var row = parseInt($(this).closest('tr').attr('row'));
		if (form2.currentRow != row){
			form2.currentRow = row;
			$.ajax({
				url: form2.urls['submit'],
				data: {data: form2.submitData(),submit:2},
				method: 'patch',
				dataType: 'json',
				success: function(data){
					var index_ids = $.parseJSON(data['result']);
					for(index in index_ids){
						var tr =$('.form2 [index=' + index + ']')
						tr.find('.form2-value-id').attr('value',index_ids[index]);
						tr.attr('update',0);
					}	
					form2.refreshRows();
				}
			})
		}
	})

	$('.form2-edit').on('click','.form2-value-delete',function(e){
			e.preventDefault();
			var tr = $(this).closest('tr')
			var index = tr.attr('index');
			var id = tr.find('.form2-value-id').attr('value')

			if (id){
				$.ajax({
					url: form2.urls['remove'] + id,
					method: 'delete',
					dataType: 'json',
					success: function(data){
						if (data['result'].toLowerCase()==="ok"){
							tr.remove();
							form2.refreshRows();
						}
					}
				})
			}else{
				$(this).closest('tr').remove();
				form2.refreshRows();
			}
	})

	$('.form2-edit').on('click','.form2-value-new',function(e){
			e.preventDefault();

			var index = parseInt($('.form2-edit tr').last().attr('index')) +1;

			$.ajax({
				url: form2.urls['add'],
				data:{index: index},
				method:'get',
				dataType: 'json',
				success: function(data){
					$('.form2 tbody').append(data['template']);
					form2.addCustomerSelect2($('.form2-value-' + index + ' .form2-value-customer'));
					form2.refreshRows();
				}
			})
	})

	$('.form2-edit').on('change','input,select',function(){
		$($(this).closest('tr')).attr('update',1)
		console.log('change');
		form2.refreshRows();
	})



})


</script>