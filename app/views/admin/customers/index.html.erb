<div class="menu-box">
	<div class="menu-inner-1">
		<%= link_to "客戶", admin_customers_path,:class=>"selected"%>
		<%= link_to "送貨員",admin_delivery_people_path,:class=>"", :content=>".admin-delivery-people"%>
		<%= link_to "廠商", admin_manufacturers_path,:class=>"", :content=>".admin-manufacturer"%>
	</div>
</div>

<div class="content-box">
	<div class="content-inner">
		<div class="admin-customers">
			<%= render :partial=>"admin/customers/index.html", :locals=>{:customers=>@customers, :search_key=>@search_key} %>
		</div>

		<div class="admin-customer-show" style="display:none"></div>
		<div class="admin-customer-form" style="display:none"></div>
	</div>
</div>

<script>
	
	var adminCustomer = {
		urls: {
			indexPath: function(){
				return ("/admin/customers");
			},
			newPath: function(){
				return ("/admin/customers/new");
			},
			showPath: function(customerId){
				return ("/admin/customers/" + customerId);
			},
			createPath: function(){
				return ("/admin/customers")
			},
			editPath: function(customerId){
				return ("/admin/customers/" + customerId + "/edit");
			},
			updatePath: function(customerId){
				return ("/admin/customers/" + customerId);
			},
			destroyPath:function(customerId){
				return ("/admin/customers/" + customerId);				
			},
			setStatus:function(customerId){
				return ("/admin/customers/" + customerId + "/set_status");
			}
		},
		showViews: function(view){
			$('.admin-customers').hide();
			$('.admin-customer-show').hide();
			$('.admin-customer-form').hide();

			if (view=="index"){
				$('.admin-customers').show();				
			}else if(view=="show"){
				$('.admin-customer-show').show();				
			}else if(view=="form"){
				$('.admin-customer-form').show();				
			}
		},
		newPage: function(e){
			e.preventDefault();
			$.ajax({
				url: this.urls.newPath(),
				dataType: 'json',
				success:function(data){
					$('.admin-customer-form').html(data['template'])
					adminCustomer.showViews('form')
				}
			})
		},
		showPage: function(e,customerId){
			e.preventDefault();
			$.ajax({
				url: adminCustomer.urls.showPath(customerId),
				dataType: 'json',
				success:function(data){
					$('.admin-customer-show').html(data['template']);
					adminCustomer.showViews("show");
				}
			})
		},
		editPage: function(e,customerId){
			e.preventDefault();
			$.ajax({
				url: this.urls.editPath(customerId),
				dataType: 'json',
				method: 'get',
				success: function(data){
					$('.admin-customer-form').html(data['template']);
					adminCustomer.showViews("form");				
				}
			})
		},
		destroy: function(e,customerId){
			e.preventDefault();
			if (confirm('即將刪除')){
				$.ajax({
					url: this.urls.destroyPath(customerId),
					dataType: 'json',
					method: 'delete',
					success: function(data){
						if (data['result'].toLowerCase()=="ok"){
							location.reload();
						}
					}
				})				
			}
		},
		create: function(e, object){
			e.preventDefault();
			var data = $(object).closest('form').serialize();
			$.ajax({
				url: this.urls.createPath(),
				dataType: 'json',
				method: 'post',
				data: data,
				success: function(data){
					$('.admin-customer-show').html(data['template']);
					adminCustomer.showViews("show");
				}
			})
		},
		update: function(e,customerId,object){
			e.preventDefault();
			var data = $(object).closest('form').serialize();
			$.ajax({
				url: this.urls.updatePath(customerId),
				dataType: 'json',
				method: 'patch',
				data:data,
				success: function(data){
					$('.admin-customer-show').html(data['template']);
					adminCustomer.showViews("show");				
				}
			})
		},
		setStatus: function(e,customerId,object){
			e.preventDefault();
			var submitData = {};
			if ($(object).text()=="經營中"){
				submitData['status'] = "結束"
			}else if($(object).text()=="結束"){
				submitData['status'] = "經營中"
			}

			$.ajax({
				url: this.urls.setStatus(customerId),
				dataType: "json",
				method:'post',
				data: submitData,
				success:function(data){
					if (data['result'].toLowerCase()=="ok"){
						$(object).text(submitData['status']);
						adminCustomer.refreshStatus();
					}
				}
			})			
		},
		refreshStatus: function(){
			$('.customer-status').each(function(i,elm){
				var text = $(elm).text();
				if(text=="經營中"){
					$(elm).addClass('active');
					$(elm).removeClass('inactive');					
				}else if(text=="結束"){
					$(elm).addClass('inactive');
					$(elm).removeClass('active');					
				}
			})
		},
		addCustomerRow: function(e,object){
			e.preventDefault();
			var tr = $(object).closest('tr');
			var index = parseInt(tr.attr('index'));
			var newTr = tr.clone();
			newTr.find('[name]').each(function(i,elm){
				var name = $(elm).attr('name');
				var id = $(elm).attr('id');
				$(elm).attr('name', $(elm).attr('name').replace(index,index+1));
				$(elm).attr('id', $(elm).attr('id').replace(index,index+1));
				$(elm).val("");
			})
			newTr.find('label').each(function(i,elm){
				$(elm).text($(elm).text().replace(index+1,index+2));
			})
			newTr.attr('index',index+1)
			tr.find('a').remove();

			tr.after(newTr);
		},
		removeCustomerRow: function(e,object){
			e.preventDefault();
			var tr = $(object).closest('tr');
		}
	}

	adminCustomer.refreshStatus();

	var customerRow = function(tr,index){
		this.tr = $(tr);
		this.index = function(){
			return parseInt(this.tr.attr('index'));
		};
		this.addIndex = function(){
			var newIndex = this.index+1
			this.tr.find('[name]').each(function(index,elm){
				var nameStr = $(elm).attr('name');
				var idStr = $(elm).attr('id');
				$(elm).attr('name',nameStr.replace('['+this.index+']','['+newIndex+']'));
				$(elm).attr('id', idStr, repalce('_' + this.index) + '+','_' + newIndex +'_')

			})
		};
		this.names = function(){
				this.tr.find('[name]').each(function(index,elm){
				console.log($(elm).attr('name'));
				console.log($(elm).attr('id'));				
				console.log('----');
			})
		}
	}

	var railsInput = function(objectName,subName,index){
		this.objectName = objectName;
		this.subName = subName;
		this.index = index;

		this.htmlInput = function(typeName,attribute){
			var nameStr = this.objectName + '[' + this.subName + '_attributes][' + this.index + '][' + attribute + ']';
			var idStr = this.objectName + '_' + this.subName + '_attributes_' + this.index + '_' + attribute;
			var inputElm = $('<input>')
			inputElm.attr('type',typeName);
			inputElm.attr('name',nameStr);
			inputElm.attr('id',idStr);
			inputElm.attr('class',this.className);

			console.log(nameStr);
			console.log(idStr);
			console.log(inputElm);
			return inputElm;
		};
	}

</script>



