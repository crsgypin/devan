
<div class="menu-box">
	<div class="menu-inner">
		<%= link_to "今日路線", "",:class=>"selected",:content=>".customer-route"%>
		<%= link_to "查詢","", :content=>".customer-search"%>
	</div>
</div>

<div class="content-box">
	<div class="content-inner">

		<div class="customer-index">
			
			<div class="customer-route">
				<div class="info">
					<h1>路線(<%=@customer_routes.length%>)</h1>
					<div class="date-selector">
						<%= select_tag "date_select", options_for_select(date_list), :class=>"date-select", :url=> update_date_customers_path %>				
					</div>					
				</div>

				<div class="list">
					<%= render :partial=>'customers/customer_route_list', :locals=>{:customer_routes=>@customer_routes} %>
				</div>
				
				<div class="map-box">
					<div>
					  <div id="map"></div>
					</div>
				</div>

			</div>

			<div class="customer-search" style="display:none;">
				<div class="search-box">
					<%= form_tag customers_path, :method=>:get do %>
						<div class="box1">
							<%= text_field_tag "customer_search", {}, :value=> @customer_search %>
							<%= submit_tag "搜尋", :class=>"btn btn-primary btn-xs" %>		
						</div>
						<div class="box2">
							<div class="field">
								<%= hidden_field_tag "customer_code", 0, :id=>"customer_code_hidden" %>
								<%= check_box_tag "customer_code",1, @customer_code %>
								<%= label_tag "customer_code", "編號" %>							
							</div>
							<div class="field">
								<%= hidden_field_tag "customer_name", 0, :id=>"customer_name_hidden" %>
								<%= check_box_tag "customer_name",1, @customer_name %>
								<%= label_tag "customer_name", "店名" %>							
							</div>
							<div class="field">
								<%= hidden_field_tag "customer_address", 0, :id=>"customer_address_hidden" %>
								<%= check_box_tag "customer_address", 1, @customer_address %>
								<%= label_tag "customer_address", "地址" %>							
							</div>
							<div class="field">
								<%= hidden_field_tag "customer_phone", 0, :id=>"customer_phone_hidden" %>
								<%= check_box_tag "customer_phone",1, @customer_phone %>
								<%= label_tag "customer_phone", "電話" %>							
							</div>
							<%= select_tag "customer_city", options_for_select(City.all.map{|c| [c.name, c.id]}, @customer_city), :prompt=>"全部縣市" %>						
						</div>
					<% end %>
				</div>

				<div class="page-box">
					<%= paginate @customers %>								
				</div>

				<table class="table table-striped customer-index-table">
					<thead>
						<tr>
							<th width="5%"></th>
							<th width="10%"> 編號 </th>
							<th width="15%"> 名字 </th>
							<th width="10%"> 縣市 </th>
							<th width="10%"> 狀態 </th>
							<th width="20%"> 地址 </th>
							<th width="20%"> 電話 </th>
							<th width="5%"></th>
						</tr>
					</thead>

					<tbody>
						<% @customers.each_with_index do |customer,index| %>
							<tr>
								<td> <%= index+1 %> </td>
								<td> <%= customer.code %> </td>
								<td> <%= customer.name %> </td>
								<td> <%= customer.addresses.first.city.try(:name) if customer.addresses.first %> </td>
								<td> <%= customer.status %></td>
								<td>
									<%= customer.addresses.first.try(:address) %>
								</td>

								<td> <%= customer.phones.map{|p| p.number}.join(',') %> </td>
								<td> <%= link_to "基本資料",customer_path(customer), :class=>"btn btn-warning btn-xs" %> </td>
							</tr>
						<% end %>

					</tbody>
				</table>
			</div>

		</div>

	</div> <%# content-inner %>
</div> <%# content-box %>

<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>				

<script>

var map;
var markers=[];
var bounds;
function initMap(lat, lng) {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: lat, lng: lng},
    zoom: 13
  });
}

function markCurrentLocation(loc){
	initMap(loc.coords.latitude, loc.coords.longitude);
}

function vMarker(lat,lng,infoContent,map){
	var _this = this;
	this.infoWindow = new google.maps.InfoWindow({
		content:infoContent
	})
	this.marker = new google.maps.Marker({
		position: {lat:lat,lng:lng}
	})
	this.map = map;

	this.showMarker = function(){
		_this.marker.setMap(_this.map)
	}

	this.openInfoWindow = function(){
		_this.infoWindow.open(_this.map, _this.marker);
	}

	this.closeInfoWindow = function(){
		_this.infoWindow.close();
	}

	this.marker.addListener('click',function(){
		_this.infoWindow.open(_this.map, _this.marker);
	})
}	

$(document).ready(function(){

//route page
	var customer_markers = <%=raw @markers %>;

	initMap(customer_markers[0].lat, customer_markers[0].lng);

	for(i=0;i<customer_markers.length;i++){
		var cm = customer_markers[i]
		var vm = new vMarker(cm.lat, cm.lng, cm.info, map)
		markers.push(vm);
	}
	// navigator.geolocation.getCurrentPosition(markCurrentLocation);

	markers.forEach(function(marker){
		marker.showMarker();
	})

	$('.customer-route').on('click','tr',function(e){
		var index = parseInt($(this).attr('index'));
		updateMap(index);
	})

	var updateMap = function(index){
		$('.customer-index').find('[index]').removeClass('selected');
		$('.customer-index').find('[index]').removeClass('subselected');
		$($('.customer-index').find('[index=' + index + ']')).addClass('selected');

		var subindex = (index < customer_markers.length-1)? index+1 : index-1
		$($('.customer-index').find('[index=' + (subindex) + ']')).addClass('subselected');			
		
		markers.forEach(function(marker){
			marker.closeInfoWindow();
		})

		var mainMarker = markers[index];
		var subMarker = markers[subindex];
		bounds = new google.maps.LatLngBounds();
    bounds.extend(mainMarker.marker.getPosition());
    bounds.extend(subMarker.marker.getPosition());
    map.fitBounds(bounds);

    bd = new boundd(bounds);


		mainMarker.openInfoWindow();
		subMarker.openInfoWindow();
	}

	var boundd = function(bounds){
		this.bounds = bounds
	}


//date select
	$('.customer-route .date-select').change(function(e){
		e.preventDefault();
		$.ajax({
			url: $(this).attr('url'),
			data: {day:$(this).val()},
			dataType: "json",
			success: function(data){

				customer_markers = JSON.parse(data['markers']);
				$('.customer-route .list').html(data['template'])
				updateMap(0);
			}
		})
	})


});

</script>


