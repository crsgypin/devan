
<div class="menu-box">
	<div class="menu-inner">
		<%= link_to "今日路線", "",:class=>"selected",:content=>".customer-route"%>
		<%= link_to "查詢","", :content=>".customer-search"%>
	</div>
</div>

<div class="content-box">
	<div class="content-inner">

		<div class="customer-index">
			
			<div class="customer-route">
				<h1>路線(20)</h1>
				<%= select_tag "date_select", options_for_select(@date_list), :class=>"date-select", :url=> update_date_customers_path %>

				<div class="list">
					<%= render :partial=>'customers/customer_route_list', :locals=>{:map_customers=>@map_customers} %>
				</div>
				
				<div class="map">
					<div style='width: 550px;'>
					  <div id="map" style='width: 550px; height: 450px;'></div>
					</div>
				</div>

			</div>

			<div class="customer-search" style="display:none;">
				<div class="search-box">
					<%= form_tag customers_path, :method=>:get do %>
						<div class="box1">
							<%= text_field_tag "customer_search", {}, :value=> @customer_search %>
							<%= submit_tag "搜尋", :class=>"btn btn-primary btn-xs" %>		
						</div>
						<div class="box2">
							<div class="field">
								<%= hidden_field_tag "customer_code", 0, :id=>"customer_code_hidden" %>
								<%= check_box_tag "customer_code",1, @customer_code %>
								<%= label_tag "customer_code", "編號" %>							
							</div>
							<div class="field">
								<%= hidden_field_tag "customer_name", 0, :id=>"customer_name_hidden" %>
								<%= check_box_tag "customer_name",1, @customer_name %>
								<%= label_tag "customer_name", "店名" %>							
							</div>
							<div class="field">
								<%= hidden_field_tag "customer_address", 0, :id=>"customer_address_hidden" %>
								<%= check_box_tag "customer_address", 1, @customer_address %>
								<%= label_tag "customer_address", "地址" %>							
							</div>
							<div class="field">
								<%= hidden_field_tag "customer_phone", 0, :id=>"customer_phone_hidden" %>
								<%= check_box_tag "customer_phone",1, @customer_phone %>
								<%= label_tag "customer_phone", "電話" %>							
							</div>
							<%= select_tag "customer_city", options_for_select(City.all.map{|c| [c.name, c.id]}, @customer_city), :prompt=>"全部縣市" %>						
						</div>
					<% end %>
				</div>

				<div class="page-box">
					<%= paginate @customers %>								
				</div>

				<table class="table table-striped customer-index-table">
					<thead>
						<tr>
							<th width="5%"></th>
							<th width="10%"> 編號 </th>
							<th width="15%"> 名字 </th>
							<th width="10%"> 縣市 </th>
							<th width="10%"> 狀態 </th>
							<th width="20%"> 地址 </th>
							<th width="20%"> 電話 </th>
							<th width="5%"></th>
						</tr>
					</thead>

					<tbody>
						<% @customers.each_with_index do |customer,index| %>
							<tr>
								<td> <%= index+1 %> </td>
								<td> <%= customer.code %> </td>
								<td> <%= customer.name %> </td>
								<td> <%= customer.addresses.first.city.try(:name) if customer.addresses.first %> </td>
								<td> <%= customer.status %></td>
								<td>
									<%= customer.addresses.first.try(:address) %>
								</td>

								<td> <%= customer.phones.map{|p| p.number}.join(',') %> </td>
								<td> <%= link_to "基本資料",customer_path(customer), :class=>"btn btn-warning btn-xs" %> </td>
							</tr>
						<% end %>

					</tbody>
				</table>
			</div>

		</div>

	</div> <%# content-inner %>
</div> <%# content-box %>

<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>				

<script>


$(document).ready(function(){

//route page
	var customer_markers = <%= @markers %>;

	$('.customer-route').on('click','tr',function(e){
		var index = parseInt($(this).attr('index'));
		updateMap(index);
	})

	var updateMap = function(index){
		$('.customer-index').find('[index]').removeClass('selected');
		$('.customer-index').find('[index]').removeClass('subselected');
		$($('.customer-index').find('[index=' + index + ']')).addClass('selected');

		var subindex = (index < customer_markers.length-1)? index+1 : index-1
		$($('.customer-index').find('[index=' + (subindex) + ']')).addClass('subselected');			
		buildMap( [customer_markers[index], customer_markers[subindex]] );			



	}

	var buildMap = function(selected_markers){
		handler = Gmaps.build('Google');
		handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
		  markers = handler.addMarkers(selected_markers);

		  handler.bounds.extendWith(markers);
		  handler.map.centerOn(markers[0]);
		  handler.fitMapToBounds();

		  marker = markers[0].getServiceObject();
		  google.maps.event.addListener(marker, 'mouseover', function() {
		  	console.log('mouseover');

		  	// var infowindow = new google.maps.InfoWindow({content: 'content' });
		  	// console.log(infowindow);
     //    infowindow.open( handler.getMap());
        // infowindow.serviceObject.open(Gmaps.map.map, marker.serviceObject);
      });

		});		
	}

	updateMap(0);

//date select
	$('.customer-route .date-select').change(function(e){
		e.preventDefault();

		$.ajax({
			url: $(this).attr('url'),
			data: {day:$(this).val()},
			dataType: "json",
			success: function(data){

				customer_markers = JSON.parse(data['markers']);
				$('.customer-route .list').html(data['template'])
				updateMap(0);
			}
		})
	})


});

</script>

<%#
	handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
	  markers = handler.addMarkers([
	    {
	      "lat": 25.0822863,
	      "lng": 121.5494786,
	      "picture": {
	        "width":  36,
	        "height": 36
	      },
	      "infowindow": "hello!"
	    },
	    {
	    	"lat":25.09,
	    	"lng":121.551,
	    	"infowindow": "Yep"
	    }
	  ]);

%>


